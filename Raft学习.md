### Raft 三个子问题

* 领导选举
* 日志复制
* 安全性：不同节点同一个日志索引位置不能应用不同的指令



### 状态

**持久状态 Persistent**

1. **currentTerm** 已知的最新任期

2. **votedFor** 收到选票的candidateid

3. log[] 日志条目 {命令，任期}

**易失状态 Volatile**

1. On all servers 
   	1. commitIndex 已知已提交的最高的日志条目的索引
   	1. lastApplied 已经被应用到状态机的最高的日志条目的索引

2. On leaders 选举后重新初始化
   1. nextIndex[] 对于每一台服务器，**下一条日志的索引**
   2. matchIndex[] 对于每一台服务器，**已知的已经复制到服务器的最高条目索引**



### RPC

**追加条目（AppendEntries）RPC**

| 参数             | 解释                                                         |
| ---------------- | ------------------------------------------------------------ |
| **term**         | 领导人的任期                                                 |
| **leaderId**     | 领导人 ID 因此跟随者可以**对客户端进行重定向**（译者注：跟随者根据领导人 ID 把客户端的请求重定向到领导人，比如有时**客户端把请求发给了跟随者而不是领导人**） |
| **prevLogIndex** | 紧邻新日志条目**之前的那个日志条目的索引**                   |
| **prevLogTerm**  | 紧邻新日志条目**之前的那个日志条目的任期**                   |
| **entries[]**    | **需要被保存的日志条目**（被当做心跳使用时，则**日志条目内容为空**；为了提高效率**可能一次性发送多个**） |
| **leaderCommit** | **领导人的已知已提交的最高的日志条目的索引**                 |



| 返回值      | 解释                                                         |
| ----------- | ------------------------------------------------------------ |
| **term**    | **当前任期**，对于领导人而言 它会更新自己的任期              |
| **success** | 如果跟随者所含有的**条目和 prevLogIndex 以及 prevLogTerm 匹配上**了，则为 true |



接收者的实现：

1. **任期检查**返回**假** 如果领导人的**任期小于接收者**的当前任期
2. **日志索引和任期检查** 返回**假** 如果接收者日志中**没有包含这样一个条目** 即**该条目的任期在 prevLogIndex 上能和 prevLogTerm 匹配上** （译者注：在接收者日志中 如果能找到一个和 prevLogIndex 以及 prevLogTerm 一样的索引和任期的日志条目 则继续执行下面的步骤 否则返回假）（5.3 节）
3. **删除冲突** 如果一个已经存在的条目和新条目（译者注：即刚刚接收到的日志条目）发生了冲突（因为索引相同，任期不同），那么就**删除这个已经存在的条目以及它之后的所有条目** （5.3 节）
4. **追加 ** 日志中尚未存在的任何**新条目**
5. **更新commitIndex**。 如果领导人的已知已提交的最高日志条目的索引大于接收者的已知已提交最高日志条目的索引（**`leaderCommit > commitIndex`**），则把接收者的已知已经提交的最高的日志条目的索引commitIndex 重置为 领导人的已知已经提交的最高的日志条目的索引 **leaderCommit 或者是 上一个新条目的索引 取两者的最小值**



**请求投票PRC** (RequestVote) RPC

| 参数             | 解释                             |
| ---------------- | -------------------------------- |
| **term**         | 候选人的**任期号**               |
| **candidateId**  | 请求选票的候选人的 ID            |
| **lastLogIndex** | 候选人的**最后日志条目的索引值** |
| **lastLogTerm**  | 候选人**最后日志条目的任期号**   |

| 返回值          | 解释                                           |
| --------------- | ---------------------------------------------- |
| **term**        | **当前任期号**，以便于候选人去更新自己的任期号 |
| **voteGranted** | 候选人赢得了此张选票时为真                     |

接收者实现：

1. 如果`term < currentTerm`返回 false （5.2 节）
2. 如果 **votedFor 为空**或者为 **candidateId**，并且候选人的日志**至少和自己一样新**，那么就投票给他（5.2 节，5.4 节）





#### 服务器规则

**所有服务器需遵守的规则**：

#### 所有服务器：

- **commit检查**如果`commitIndex > lastApplied`，则 lastApplied 递增，并将`log[lastApplied]`应用到状态机中（5.3 节）
- **任期检查**如果接收到的 RPC 请求或响应中，任期号`T > currentTerm`，则令 `currentTerm = T`，并切换为跟随者状态（5.1 节）

#### 跟随者（5.2 节）Follower：

- 响应来自候选人和领导人的请求
- 如果在**超过选举超时时间**的情况之前没有收到**当前领导人**（即该领导人的任期需与这个跟随者的当前任期相同）的**心跳/附加日志**，或者是**给某个候选人投了票**，就**自己变成候选人**

#### 候选人（5.2 节）：

- 在转变成候选人后就**立即开始选举过程**
  - **自增当前的任期号**（currentTerm）
  - **给自己投票**
  - 重置**选举超时计时器**
  - **发送请求投票的 RPC** 给其他所有服务器
- 如果接**收到大多数服务器的选票**，那么就变成领导人
- 如果接收到**来自新的领导人**的附加日志（AppendEntries）RPC，则转变成跟随者
- 如果选举过程超时，则再次发起一轮选举

#### 领导人 Leader：

- 一旦成为领导人：发送**空的附加日志（AppendEntries）RPC（心跳）给其他所有的服务器**；在一定的空余时间之后不停的重复发送，以防止跟随者超时（5.2 节）

- 如果接收到来自客户端的请求：**附加**条目到本地日志中，在条目被**应用**到状态机后**响应客户端**（5.3 节）

- 如果对于一个跟随者，最后日志条目的索引值大于等于 nextIndex（

  ```
  lastLogIndex ≥ nextIndex
  ```

  ），则发送从 nextIndex 开始的所有日志条目：

  - 如果成功：**更新相应跟随者的 nextIndex 和 matchIndex**
  - 如果因为日志不一致而失败，则 **nextIndex 递减并重试**

- 假设存在 N 满足`N > commitIndex`，使得大多数的 `matchIndex[i] ≥ N`以及`log[N].term == currentTerm` 成立，则令 `commitIndex = N`（5.3 和 5.4 节）



| 特性                 | 解释                                                         |
| -------------------- | ------------------------------------------------------------ |
| **选举安全特性**     | **一个任期一个领导**。对于一个给定的任期号，最多只会有一个领导人被选举出来（5.2 节） |
| **领导人只附加原则** | **leader只负责追加**领导人绝对不会删除或者覆盖自己的日志，只会增加（5.3 节） |
| **日志匹配原则**     | 如果两个日志在某一**相同索引**位置日志条目的**任期号相同**，那么我们就认为这两个日志**从头到该索引位置之间的内容完全一致**（5.3 节） |
| **领导人完全特性**   | 如果某个日志条目在某个任期号中**已经被提交**，那么这个条目必然出现在更大任期号的**所有领导人中**（5.4 节） |
| **状态机安全特性**   | 如果某一服务器已将**给定索引位置的日志条目**应用至其状态机中，则其他任何服务器在该索引位置不会应用不同的日志条目（5.4.3 节） |





